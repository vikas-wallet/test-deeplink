<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deeplink Redirect</title>
</head>
<body>
    <script>
        var appURL = "rakutenwalletweb3://";
        var appOpened = false;
        var previousPage = document.referrer; // Get the previous page URL

        function redirectToPreviousPage() {
            if (previousPage) {
                window.location.href = previousPage; // Redirect to the previous page
            } else {
                // If document.referrer is empty, provide a fallback
                alert("Could not determine previous page. Please navigate back manually.");
            }
        }

        function showAlert() {
            alert("Rakuten Wallet Web3 app may not be installed. Click OK to return to the previous page.");
            redirectToPreviousPage();
        }

        var alertTimer = setTimeout(function() {
            if (!appOpened) {
                showAlert();
            }
        }, 500);

        function handleAppOpen() {
            appOpened = true;
            clearTimeout(alertTimer);
        }

        // Listen for both blur and visibilitychange events
        window.addEventListener('blur', handleAppOpen);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                handleAppOpen();
            }
        });

        // Delay the deeplink attempt slightly to allow event listeners to attach
        setTimeout(function() {
            window.location.replace(appURL);

            // If the page is still visible after a short time, assume the app didn't open
            setTimeout(function() {
                if (!appOpened) {
                    showAlert();
                }
            }, 1000);
        }, 100);
    </script>
</body>
</html>
